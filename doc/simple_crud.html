<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>CRUD example for multpile backends</title>

    
    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <h1 class="title">CRUD example for multpile backends</h1>
    <nav id="TOC"><ul></ul></nav>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">rand</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">s3</span>;

<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">str</span>;

<span class="kw">use</span> <span class="ident">s3</span>::<span class="ident">bucket</span>::<span class="ident">Bucket</span>;
<span class="kw">use</span> <span class="ident">s3</span>::<span class="ident">creds</span>::<span class="ident">Credentials</span>;
<span class="kw">use</span> <span class="ident">s3</span>::<span class="ident">S3Error</span>;
<span class="kw">use</span> <span class="ident">s3</span>::<span class="ident">region</span>::<span class="ident">Region</span>;

<span class="kw">struct</span> <span class="ident">Storage</span> {
    <span class="ident">name</span>: <span class="ident">String</span>,
    <span class="ident">region</span>: <span class="ident">Region</span>,
    <span class="ident">credentials</span>: <span class="ident">Credentials</span>,
    <span class="ident">bucket</span>: <span class="ident">String</span>,
    <span class="ident">location_supported</span>: <span class="ident">bool</span>,
}

<span class="kw">const</span> <span class="ident">MESSAGE</span>: <span class="kw-2">&amp;</span><span class="ident">str</span> <span class="op">=</span> <span class="string">&quot;I want to go to S3&quot;</span>;

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">main</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span>(), <span class="ident">S3Error</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">aws</span> <span class="op">=</span> <span class="ident">Storage</span> {
        <span class="ident">name</span>: <span class="string">&quot;aws&quot;</span>.<span class="ident">into</span>(),
        <span class="ident">region</span>: <span class="string">&quot;eu-central-1&quot;</span>.<span class="ident">parse</span>()<span class="question-mark">?</span>,
        <span class="ident">credentials</span>: <span class="ident">Credentials</span>::<span class="ident">from_profile</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;rust-s3&quot;</span>))<span class="question-mark">?</span>,
        <span class="ident">bucket</span>: <span class="string">&quot;rust-s3-test&quot;</span>.<span class="ident">to_string</span>(),
        <span class="ident">location_supported</span>: <span class="bool-val">true</span>,
    };

    <span class="kw">let</span> <span class="ident">aws_public</span> <span class="op">=</span> <span class="ident">Storage</span> {
        <span class="ident">name</span>: <span class="string">&quot;aws-public&quot;</span>.<span class="ident">into</span>(),
        <span class="ident">region</span>: <span class="string">&quot;eu-central-1&quot;</span>.<span class="ident">parse</span>()<span class="question-mark">?</span>,
        <span class="ident">credentials</span>: <span class="ident">Credentials</span>::<span class="ident">anonymous</span>()<span class="question-mark">?</span>,
        <span class="ident">bucket</span>: <span class="string">&quot;rust-s3-public&quot;</span>.<span class="ident">to_string</span>(),
        <span class="ident">location_supported</span>: <span class="bool-val">true</span>,
    };

    <span class="kw">let</span> <span class="ident">minio</span> <span class="op">=</span> <span class="ident">Storage</span> {
        <span class="ident">name</span>: <span class="string">&quot;minio&quot;</span>.<span class="ident">into</span>(),
        <span class="ident">region</span>: <span class="ident">Region</span>::<span class="ident">Custom</span> {
            <span class="ident">region</span>: <span class="string">&quot;us-east-1&quot;</span>.<span class="ident">into</span>(),
            <span class="ident">endpoint</span>: <span class="string">&quot;https://minio.adder.black&quot;</span>.<span class="ident">into</span>(),
        },
        <span class="ident">credentials</span>: <span class="ident">Credentials</span>::<span class="ident">from_profile</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;minio&quot;</span>))<span class="question-mark">?</span>,
        <span class="ident">bucket</span>: <span class="string">&quot;rust-s3-test&quot;</span>.<span class="ident">to_string</span>(),
        <span class="ident">location_supported</span>: <span class="bool-val">false</span>,
    };

    <span class="kw">let</span> <span class="ident">yandex</span> <span class="op">=</span> <span class="ident">Storage</span> {
        <span class="ident">name</span>: <span class="string">&quot;yandex&quot;</span>.<span class="ident">into</span>(),
        <span class="ident">region</span>: <span class="string">&quot;ru-central1&quot;</span>.<span class="ident">parse</span>()<span class="question-mark">?</span>,
        <span class="ident">credentials</span>: <span class="ident">Credentials</span>::<span class="ident">from_profile</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;yandex&quot;</span>))<span class="question-mark">?</span>,
        <span class="ident">bucket</span>: <span class="string">&quot;soundcloud&quot;</span>.<span class="ident">to_string</span>(),
        <span class="ident">location_supported</span>: <span class="bool-val">false</span>,
    };

    <span class="kw">for</span> <span class="ident">backend</span> <span class="kw">in</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">aws_public</span>, <span class="ident">aws</span>, <span class="ident">yandex</span>] {
        <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Running {}&quot;</span>, <span class="ident">backend</span>.<span class="ident">name</span>);
        <span class="comment">// Create Bucket in REGION for BUCKET</span>
        <span class="kw">let</span> <span class="ident">bucket</span> <span class="op">=</span> <span class="ident">Bucket</span>::<span class="ident">new</span>(<span class="kw-2">&amp;</span><span class="ident">backend</span>.<span class="ident">bucket</span>, <span class="ident">backend</span>.<span class="ident">region</span>, <span class="ident">backend</span>.<span class="ident">credentials</span>)<span class="question-mark">?</span>;

        <span class="comment">// List out contents of directory</span>
        <span class="kw">let</span> <span class="ident">results</span> <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">list_blocking</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>(), <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
        <span class="kw">for</span> (<span class="ident">list</span>, <span class="ident">code</span>) <span class="kw">in</span> <span class="ident">results</span> {
            <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="number">200</span>, <span class="ident">code</span>);
            <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="ident">list</span>.<span class="ident">contents</span>.<span class="ident">len</span>());
        }

        <span class="comment">// Make sure that our &quot;test_file&quot; doesn&#39;t exist, delete it if it does. Note</span>
        <span class="comment">// that the s3 library returns the HTTP code even if it indicates a failure</span>
        <span class="comment">// (i.e. 404) since we can&#39;t predict desired usage. For example, you may</span>
        <span class="comment">// expect a 404 to make sure a fi le doesn&#39;t exist.</span>
        <span class="comment">//    let (_, code) = bucket.delete(&quot;test_file&quot;)?;</span>
        <span class="comment">//    assert_eq!(204, code);</span>

        <span class="comment">// Put a &quot;test_file&quot; with the contents of MESSAGE at the root of the</span>
        <span class="comment">// bucket.</span>
        <span class="kw">let</span> (<span class="kw">_</span>, <span class="ident">code</span>) <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">put_object_blocking</span>(<span class="string">&quot;test_file&quot;</span>, <span class="ident">MESSAGE</span>.<span class="ident">as_bytes</span>(), <span class="string">&quot;text/plain&quot;</span>)<span class="question-mark">?</span>;
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="number">200</span>, <span class="ident">code</span>);

        <span class="comment">// Get the &quot;test_file&quot; contents and make sure that the returned message</span>
        <span class="comment">// matches what we sent.</span>
        <span class="kw">let</span> (<span class="ident">data</span>, <span class="ident">code</span>) <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">get_object_blocking</span>(<span class="string">&quot;test_file&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">string</span> <span class="op">=</span> <span class="ident">str</span>::<span class="ident">from_utf8</span>(<span class="kw-2">&amp;</span><span class="ident">data</span>)<span class="question-mark">?</span>;
        <span class="comment">// println!(&quot;{}&quot;, string);</span>
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="number">200</span>, <span class="ident">code</span>);
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">MESSAGE</span>, <span class="ident">string</span>);

        <span class="kw">if</span> <span class="ident">backend</span>.<span class="ident">location_supported</span> {
            <span class="comment">// Get bucket location</span>
            <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="ident">bucket</span>.<span class="ident">location_blocking</span>()<span class="question-mark">?</span>);
        }

        <span class="ident">bucket</span>.<span class="ident">put_object_tagging_blocking</span>(<span class="string">&quot;test_file&quot;</span>, <span class="kw-2">&amp;</span>[(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;tag&quot;</span>)])<span class="question-mark">?</span>;
        <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;Tags set&quot;</span>);
        <span class="kw">let</span> (<span class="ident">tags</span>, <span class="ident">_status</span>) <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">get_object_tagging_blocking</span>(<span class="string">&quot;test_file&quot;</span>)<span class="question-mark">?</span>;
        <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="ident">tags</span>);

        <span class="comment">// Test with random byte array</span>

        <span class="kw">let</span> <span class="ident">random_bytes</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="number">0</span>..<span class="number">3072</span>).<span class="ident">map</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> <span class="ident">rand</span>::<span class="ident">random</span>::<span class="op">&lt;</span><span class="ident">u8</span><span class="op">&gt;</span>()).<span class="ident">collect</span>();
        <span class="kw">let</span> (<span class="kw">_</span>, <span class="ident">code</span>) <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">put_object_blocking</span>(
            <span class="string">&quot;random.bin&quot;</span>,
            <span class="ident">random_bytes</span>.<span class="ident">as_slice</span>(),
            <span class="string">&quot;application/octet-stream&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="number">200</span>, <span class="ident">code</span>);
        <span class="kw">let</span> (<span class="ident">data</span>, <span class="ident">code</span>) <span class="op">=</span> <span class="ident">bucket</span>.<span class="ident">get_object_blocking</span>(<span class="string">&quot;random.bin&quot;</span>)<span class="question-mark">?</span>;
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">code</span>, <span class="number">200</span>);
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">data</span>.<span class="ident">len</span>(), <span class="number">3072</span>);
        <span class="macro">assert_eq</span><span class="macro">!</span>(<span class="ident">data</span>, <span class="ident">random_bytes</span>);
    }

    <span class="prelude-val">Ok</span>(())
}</pre></div>

    
</body>
</html>